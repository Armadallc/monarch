# Monarch Competency — Database Reference

> **Last Updated**: 2026-02-08 — Sprint 6 admin_ref_id system, portal UX, post-submit timeout

---

## Database Overview

- **Supabase Instance**: `esbmnympligtknhtkary.supabase.co`
- **Auth**: Google OAuth + Magic Link via Supabase Auth
- **RLS**: Enabled on both referral tables (see Security section)
- **Storage**: Private bucket `referral-documents` for HIPAA-compliant document uploads
- **Total Public Tables**: 7

| Table | Columns | Rows | Purpose |
|-------|---------|------|---------|
| `referral_inquiries` | 17 | 3 | Public intake form submissions |
| `referral_submissions` | ~134 | 35 | Professional/secure referral submissions |
| `users` | 9 | — | User accounts |
| `tenant_roles` | 8 | — | Multi-tenant role assignments |
| `role_permissions` | 8 | — | Permission definitions per role |
| `corporate_clients` | 4 | — | Corporate/organizational clients |
| `programs` | 5 | — | Monarch program definitions |

---

## Table: `referral_inquiries` (17 columns)

**Source**: `PublicInquiryForm.tsx` — public-facing, no auth required
**Purpose**: Initial intake inquiries from families, self-referrals, and general contacts
**Note**: Lightweight form — collects contact info + situation overview, NOT full clinical data

| # | Column | Type | Nullable | Default | Notes |
|---|--------|------|----------|---------|-------|
| 1 | `id` | uuid | NO | `gen_random_uuid()` | Primary key |
| 2 | `inquiry_type` | text | NO | — | "self" or "other" |
| 3 | `referral_source_name` | text | NO | — | Person submitting |
| 4 | `referral_source_phone` | text | YES | — | |
| 5 | `referral_source_email` | text | NO | — | |
| 6 | `referral_source_relationship` | text | YES | — | Relationship to client |
| 7 | `referral_source_organization` | text | YES | — | |
| 8 | `referral_source_title` | text | YES | — | |
| 9 | `client_first_name` | text | YES | — | |
| 10 | `client_last_initial` | text | YES | — | Last initial only (privacy) |
| 11 | `client_approximate_age` | text | YES | — | Approximate, not DOB |
| 12 | `client_current_location` | text | YES | — | |
| 13 | `situation_notes` | text | YES | — | Free-text description |
| 14 | `how_heard_about_us` | text | YES | — | Marketing attribution |
| 15 | `status` | text | NO | `'pending_review'` | Workflow status |
| 16 | `created_at` | timestamptz | YES | `now()` | |
| 17 | `updated_at` | timestamptz | YES | `now()` | |

### Key Differences from `referral_submissions`
- **No `priority` column** — the current dashboard incorrectly references this
- **No `referral_source_type` column** — no categorical source typing
- **No clinical data** — no DOB, SSN, diagnoses, medications, risk flags
- **`client_last_initial`** instead of `client_last_name` (privacy-preserving)
- **`client_approximate_age`** instead of `client_dob`

---

## Table: `referral_submissions` (~105 columns)

**Source**: `ReferralForm.tsx` — auth-gated secure form (14-step professional referral)
**Purpose**: Comprehensive professional referrals with full clinical, legal, risk, and insurance data

### Referral Source Info
| # | Column | Type | Nullable | Default | Notes |
|---|--------|------|----------|---------|-------|
| 1 | `id` | uuid | NO | `gen_random_uuid()` | Primary key |
| 2 | `referral_source_type` | text | NO | — | Category of referrer (see enum below) |
| 3 | `is_priority_referral` | boolean | NO | `false` | **Admin-only** — set by admissions staff on dashboard |
| 4 | `referral_source_name` | text | NO | — | Person submitting |
| 5 | `referral_source_email` | text | NO | — | Auto-filled from OAuth |
| 6 | `referral_source_phone` | text | YES | — | |
| 7 | `referral_source_organization` | text | YES | — | Activated in Sprint 5 form |
| 8 | `referral_source_title` | text | YES | — | Activated in Sprint 5 form |
| 9 | `urgent_placement` | boolean | YES | `false` | REQUEST from referral source (checkbox) |
| 10 | `can_provide_collateral` | text | YES | — | **Sprint 5** — yes/no/partial |
| 11 | `previous_monarch_referral` | text | YES | — | **Sprint 5** — yes/no/unknown |
| 12 | `referral_code` | text | YES | — | **Sprint 5** — unique code (e.g. MON-A4K7), auto-generated by trigger |
| 12b | `admin_ref_id` | text | YES | — | **Sprint 6** — admin reference ID (e.g. REF-MC-001), auto-generated by trigger |

### Client Demographics
| # | Column | Type | Nullable | Default | Notes |
|---|--------|------|----------|---------|-------|
| 13 | `client_first_name` | text | YES | — | Legal first name |
| 14 | `client_middle_name` | text | YES | — | Activated in Sprint 5 |
| 15 | `client_last_name` | text | YES | — | Full last name (PHI) |
| 16 | `client_preferred_name` | text | YES | — | Aliases/nicknames/previous names |
| 17 | `client_dob` | date | YES | — | Date of birth |
| 18 | `client_ssn` | text | YES | — | **SSN — highly sensitive PHI** (optional) |
| 19 | `client_gender` | text | YES | — | e.g. "transgender_female" |
| 20 | `client_sex_at_birth` | text | YES | — | **Sprint 5** — Male/Female |
| 21 | `client_pronouns` | text | YES | — | **Sprint 5** |
| 22 | `client_primary_language` | text | YES | — | Activated in Sprint 5 |
| 23 | `client_english_proficiency` | text | YES | — | **Sprint 5** |
| 24 | `interpreter_needed` | boolean | YES | `false` | Activated in Sprint 5 |
| 25 | `client_ethnicity` | text | YES | — | **Sprint 5** |
| 26 | `client_marital_status` | text | YES | — | **Sprint 5** |
| 27 | `client_phone` | text | YES | — | **Sprint 5** |
| 28 | `client_email` | text | YES | — | **Sprint 5** |
| 29 | `client_consents_to_referral` | text | YES | — | **Sprint 5** — yes/no/unable_to_consent |

### Additional Contacts
| # | Column | Type | Nullable | Default | Notes |
|---|--------|------|----------|---------|-------|
| 30 | `emergency_contact_name` | text | YES | — | |
| 31 | `emergency_contact_relationship` | text | YES | — | |
| 32 | `emergency_contact_phone` | text | YES | — | |
| 33 | `emergency_contact_can_provide_info` | boolean | YES | — | **Sprint 5** |
| 34 | `additional_contacts` | **jsonb** | YES | `'[]'` | **Sprint 5** — array of contact objects (see JSONB section) |

### Documents & Identification
| # | Column | Type | Nullable | Default | Notes |
|---|--------|------|----------|---------|-------|
| 35 | `documents_available` | **jsonb** | YES | `'[]'` | **Sprint 5** — array of document type strings |
| 36 | `documents_notes` | text | YES | — | **Sprint 5** — description of documents |
| 37 | `uploaded_documents` | **jsonb** | YES | — | Activated in Sprint 5 — file metadata from Supabase Storage |

### Insurance & Benefits
| # | Column | Type | Nullable | Default | Notes |
|---|--------|------|----------|---------|-------|
| 38 | `medicaid_status` | text | YES | — | Active/Suspended/Pending/Not Eligible/Unknown |
| 39 | `medicaid_id` | text | YES | — | Legacy column |
| 40 | `medicaid_mco` | text | YES | — | Legacy — dropped from form, column kept for historical data |
| 41 | `expected_payer` | text | YES | — | Legacy — dropped from form, column kept for historical data |
| 42 | `medicaid_number` | text | YES | — | **Sprint 5** |
| 43 | `medicare_status` | text | YES | — | **Sprint 5** |
| 44 | `medicare_number` | text | YES | — | **Sprint 5** |
| 45 | `has_private_insurance` | boolean | YES | — | **Sprint 5** |
| 46 | `private_insurance_details` | text | YES | — | **Sprint 5** |
| 47 | `ssdi_status` | text | YES | — | **Sprint 5** |
| 48 | `benefits_notes` | text | YES | — | **Sprint 5** |

### Legal / Court Information
| # | Column | Type | Nullable | Default | Notes |
|---|--------|------|----------|---------|-------|
| 49 | `case_number` | text | YES | — | |
| 50 | `court_jurisdiction` | text | YES | — | Colorado judicial districts (dropdown) |
| 51 | `judge_name` | text | YES | — | |
| 52 | `courtroom` | text | YES | — | **Sprint 5** |
| 53 | `attorney_name` | text | YES | — | |
| 54 | `attorney_phone` | text | YES | — | **Sprint 5** |
| 55 | `attorney_email` | text | YES | — | **Sprint 5** |
| 56 | `charges` | text | YES | — | |
| 57 | `competency_eval_date` | date | YES | — | |
| 58 | `next_court_date` | date | YES | — | |
| 59 | `competency_status` | text | YES | — | **Sprint 5 — CRITICAL** (see enum below) |
| 60 | `competency_evaluator` | text | YES | — | **Sprint 5** |

### Supervision & Bond Status
| # | Column | Type | Nullable | Default | Notes |
|---|--------|------|----------|---------|-------|
| 61 | `on_probation` | boolean | YES | — | **Sprint 5** |
| 62 | `probation_officer_contact` | text | YES | — | **Sprint 5** — conditional on `on_probation` |
| 63 | `on_parole` | boolean | YES | — | **Sprint 5** |
| 64 | `parole_officer_contact` | text | YES | — | **Sprint 5** — conditional on `on_parole` |
| 65 | `active_warrants` | text | YES | — | **Sprint 5** — yes/no/unknown |
| 66 | `has_bond_holds` | text | YES | — | **Sprint 5** — yes/no/unknown |
| 67 | `bond_holds_details` | text | YES | — | **Sprint 5** — conditional |
| 68 | `pr_bond_to_monarch` | text | YES | — | **Sprint 5** — yes/no/pending/unknown |
| 69 | `pr_bond_judge_contact` | text | YES | — | **Sprint 5** — conditional on PR bond |
| 70 | `pr_bond_da_contact` | text | YES | — | **Sprint 5** — conditional on PR bond |
| 71 | `pr_bond_other_contacts` | text | YES | — | **Sprint 5** — conditional on PR bond |

### Location / Facility
| # | Column | Type | Nullable | Default | Notes |
|---|--------|------|----------|---------|-------|
| 72 | `current_location_type` | text | YES | — | Updated options in Sprint 5 |
| 73 | `facility_name` | text | YES | — | |
| 74 | `facility_address` | text | YES | — | **Sprint 5** |
| 75 | `inmate_id` | text | YES | — | |
| 76 | `facility_contact_person` | text | YES | — | |
| 77 | `facility_contact_phone` | text | YES | — | |
| 78 | `currently_incarcerated` | boolean | YES | — | **Sprint 5** |
| 79 | `expected_release_date` | date | YES | — | **Sprint 5** — conditional on incarcerated |
| 80 | `housing_prior` | text | YES | — | **Sprint 5** |
| 81 | `housing_post_program` | text | YES | — | **Sprint 5** |
| 82 | `housing_notes` | text | YES | — | **Sprint 5** |

### Clinical / Mental Health
| # | Column | Type | Nullable | Default | Notes |
|---|--------|------|----------|---------|-------|
| 83 | `current_diagnoses` | text | YES | — | Free text |
| 84 | `current_medications` | **jsonb** | YES | — | Psychiatric medications |
| 85 | `psychiatric_history` | text | YES | — | |
| 86 | `medication_compliance` | text | YES | — | **Sprint 5** — compliant/partial/non_compliant/unknown |
| 87 | `medication_barriers` | text | YES | — | **Sprint 5** — conditional |
| 88 | `previous_treatment_programs` | text | YES | — | **Sprint 5** |
| 89 | `tbi_history` | text | YES | — | **Sprint 5** — yes/no/suspected/unknown |
| 90 | `tbi_details` | text | YES | — | **Sprint 5** — conditional |
| 91 | `idd_status` | text | YES | — | **Sprint 5** — yes/no/suspected/unknown |
| 92 | `idd_details` | text | YES | — | **Sprint 5** — conditional |

### Substance Use
| # | Column | Type | Nullable | Default | Notes |
|---|--------|------|----------|---------|-------|
| 93 | `substance_use_history` | text | YES | — | |
| 94 | `substance_use_pattern` | text | YES | — | **Sprint 5** — 8 enum options (see below) |
| 95 | `substance_use_current` | text | YES | — | **Sprint 5** — substances used in last 90 days |
| 96 | `detox_required` | text | YES | — | **Sprint 5** — yes/no/possibly/unknown |
| 97 | `detox_details` | text | YES | — | **Sprint 5** — conditional |

### Medical / Somatic
| # | Column | Type | Nullable | Default | Notes |
|---|--------|------|----------|---------|-------|
| 98 | `medical_conditions` | text | YES | — | |
| 99 | `medical_conditions_controlled` | text | YES | — | **Sprint 5** — yes/no/partially |
| 100 | `medications_non_psychiatric` | text | YES | — | **Sprint 5** |
| 101 | `medication_allergies` | text | YES | — | **Sprint 5** |
| 102 | `mobility_needs` | text | YES | — | **Sprint 5** |
| 103 | `adl_support_needed` | boolean | YES | — | **Sprint 5** |
| 104 | `adl_support_details` | text | YES | — | **Sprint 5** — conditional |
| 105 | `acute_medical_needs` | text | YES | — | **Sprint 5** |

### Risk Assessment
| # | Column | Type | Nullable | Default | Notes |
|---|--------|------|----------|---------|-------|
| 106 | `violence_risk` | **text** | YES | — | **TYPE CHANGED Sprint 5** — was boolean, now timeframe enum |
| 107 | `violence_risk_details` | text | YES | — | **Sprint 5** — conditional |
| 108 | `suicide_risk` | **text** | YES | — | **TYPE CHANGED Sprint 5** — was boolean, now timeframe enum |
| 109 | `suicide_risk_details` | text | YES | — | **Sprint 5** — conditional |
| 110 | `elopement_risk` | **text** | YES | — | **TYPE CHANGED Sprint 5** — was boolean, now timeframe enum |
| 111 | `elopement_risk_details` | text | YES | — | **Sprint 5** — conditional |
| 112 | `medical_needs` | boolean | YES | `false` | |
| 113 | `safety_notes` | text | YES | — | |
| 114 | `arson_history` | text | YES | — | **Sprint 5** — yes/no/unknown |
| 115 | `arson_details` | text | YES | — | **Sprint 5** — conditional |
| 116 | `rso_status` | text | YES | — | **Sprint 5** — yes/no/unknown |
| 117 | `rso_details` | text | YES | — | **Sprint 5** — conditional |

### Urgency & Notes
| # | Column | Type | Nullable | Default | Notes |
|---|--------|------|----------|---------|-------|
| 118 | `urgency_level` | text | YES | — | **Sprint 5** — immediate/urgent/standard/planning_ahead |
| 119 | `urgency_reason` | text | YES | — | **Sprint 5** — conditional |
| 120 | `additional_notes` | text | YES | — | |
| 121 | `referral_source_channel` | text | YES | — | **Sprint 5** — how they heard about Monarch |

### Workflow / Review
| # | Column | Type | Nullable | Default | Notes |
|---|--------|------|----------|---------|-------|
| 122 | `status` | text | NO | `'pending_review'` | Workflow status |
| 123 | `reviewed_by` | uuid | YES | — | **FK → users** |
| 124 | `reviewed_at` | timestamptz | YES | — | |
| 125 | `review_notes` | text | YES | — | |
| 126 | `archived_at` | timestamptz | YES | — | Sprint 4 soft-delete |

### Metadata / Audit
| # | Column | Type | Nullable | Default | Notes |
|---|--------|------|----------|---------|-------|
| 127 | `created_at` | timestamptz | NO | `now()` | |
| 128 | `updated_at` | timestamptz | NO | `now()` | |
| 129 | `ip_address` | inet | YES | — | Submitter IP |
| 130 | `user_agent` | text | YES | — | Browser info |
| 131 | `form_completion_percentage` | integer | YES | `0` | Progress tracking |
| 132 | `time_spent_seconds` | integer | YES | — | Time on form |
| 133 | `session_id` | uuid | YES | — | Form session |
| 134 | `last_auto_save` | timestamptz | YES | — | Auto-save timestamp |

---

## Referral Code System (Sprint 5)

### Overview
Each referral submission is automatically assigned a unique short code (e.g. `MON-A4K7`) at insert time. This code enables post-submission document uploads without requiring login.

### Database Components
- **Column**: `referral_code` text with UNIQUE index (null-safe: `WHERE referral_code IS NOT NULL`)
- **Function**: `generate_referral_code()` — PL/pgSQL function generating `MON-` + 4 random alphanumeric chars (uppercase, no ambiguous chars like O/0/I/1)
- **Trigger**: `trg_auto_referral_code` — BEFORE INSERT trigger auto-populates `referral_code` if NULL

### Post-Submission Upload Flow
1. Referral submitted → trigger generates code → code shown on confirmation screen
2. Referral source receives confirmation email with code + link
3. Source visits `/submit-referrals/documents?code=MON-A4K7`
4. Enters code + email → verified against `referral_source_email` on the matching record
5. Uploads files to Supabase Storage → `uploaded_documents` jsonb updated on referral record

---

## Admin Reference ID System (Sprint 6)

### Overview
Each referral submission is automatically assigned a sequential admin reference ID (e.g. `REF-MC-001`) at insert time. This ID is for admin use only — a human-readable, sequential identifier separate from the referral source's `referral_code` (MON-XXXX).

### Format
`REF-MC-NNN` where:
- `REF` = Reference
- `MC` = Monarch Competency
- `NNN` = Sequential number, zero-padded to 3 digits (expands to 4+ when > 999)

### Database Components
- **Column**: `admin_ref_id` text with UNIQUE index (null-safe: `WHERE admin_ref_id IS NOT NULL`)
- **Sequence**: `admin_ref_id_seq` — PostgreSQL sequence for sequential numbering
- **Function**: `generate_admin_ref_id()` — PL/pgSQL function generating `REF-MC-` + zero-padded sequence value
- **Trigger Function**: `auto_set_admin_ref_id()` — sets `admin_ref_id` if NULL at INSERT
- **Trigger**: `trg_auto_admin_ref_id` — BEFORE INSERT trigger on `referral_submissions`

### Dual ID Design
| ID | Purpose | Format | Audience | Generation |
|----|---------|--------|----------|------------|
| `referral_code` | Document uploads by referral sources | `MON-A4K7` | Referral sources | Random alphanumeric |
| `admin_ref_id` | Admin-side tracking & identification | `REF-MC-001` | Admin dashboard | Sequential |

### Migration
- **File**: `Code/Database/admin-ref-id-migration.sql`
- Existing rows backfilled in `created_at` order (oldest = REF-MC-001)
- Sequence reset to continue after last backfilled value

### Dashboard Integration
- Shown in modal header (replaces truncated UUID)
- Included in CSV, text, and HTML/print exports
- Searchable in dashboard search bar

---

## Supabase Storage

### Bucket: `referral-documents`
- **Visibility**: Private (not public)
- **RLS**: Authenticated users can upload; authenticated users can read/download
- **File path pattern**: `referrals/{referral_id}/{timestamp}_{filename}`

### RLS Policies (to create manually)
```sql
-- Allow authenticated users to upload
CREATE POLICY "Authenticated users can upload referral documents"
ON storage.objects FOR INSERT
WITH CHECK (
  bucket_id = 'referral-documents'
  AND auth.role() = 'authenticated'
);

-- Allow authenticated users to read/download
CREATE POLICY "Authenticated users can read referral documents"
ON storage.objects FOR SELECT
USING (
  bucket_id = 'referral-documents'
  AND auth.role() = 'authenticated'
);
```

---

## JSONB Field Structures

### `additional_contacts` (jsonb)
Array of contact objects. Used for additional professional contacts beyond the emergency contact.
```json
[
  {
    "name": "Jane Smith",
    "organization": "Public Defender's Office",
    "phone_email": "jane@example.com",
    "role": "Defense Attorney",
    "can_provide_info": true
  }
]
```

### `documents_available` (jsonb)
Array of document type identifier strings.
```json
["valid_co_id", "court_order", "psychiatric_records", "medication_list", "signed_roi"]
```

**Valid values**: `valid_co_id`, `expired_co_id`, `out_of_state_id`, `social_security_card`, `birth_certificate`, `insurance_cards`, `court_order`, `competency_eval`, `psychiatric_records`, `medical_records`, `medication_list`, `signed_roi`, `none_available`

### `uploaded_documents` (jsonb)
Array of file metadata objects. Populated by document uploads via Supabase Storage.
```json
[
  {
    "filename": "competency_eval.pdf",
    "storage_path": "referrals/abc123/1707400200000_competency_eval.pdf",
    "file_size": 245000,
    "mime_type": "application/pdf",
    "uploaded_at": "2026-02-08T14:30:00Z"
  }
]
```

### `current_medications` (jsonb)
Structure: Free-form JSON. May be array or object depending on form version.
Export strategy: Flatten to comma-separated string or structured text.

---

## Categorical Field Values

### `referral_source_type`
`court` | `legal_reps` | `probation_parole` | `mental_health` | `case_management` | `other_professional` | `family` | `self_referral`

> **Sprint 5**: Added `other_professional`. Family/self branch uses simplified 6-field form.

### `status`
`pending_review` (default) → `under_review` → `accepted` | `declined` | `waitlisted`

### `competency_status` (Sprint 5 — CRITICAL)
`evaluation_ordered` | `found_incompetent` | `restoration_ordered` | `in_restoration` | `restored` | `not_restorable` | `pending_evaluation`

### Risk Timeframe Enum (Sprint 5)
Used for `suicide_risk`, `violence_risk`, `elopement_risk`:
`current` (within 30 days) | `recent` (within 90 days) | `recovering` (4-12 months) | `historical` (1+ year) | `no_history`

> **Migration note**: Existing boolean data converted: `true` → `'historical'`, `false` → `'no_history'`, `NULL` → `NULL`

### `urgency_level` (Sprint 5)
`immediate` | `urgent` | `standard` | `planning_ahead`

### `substance_use_pattern` (Sprint 5)
`no_history` | `historical_only` | `in_recovery` | `occasional` | `regular` | `daily` | `iv_drug_use` | `polysubstance`

### `medicaid_status`
`active` | `suspended` | `pending` | `not_eligible` | `unknown`

### `medicare_status` (Sprint 5)
`active` | `pending` | `not_eligible` | `unknown`

### `current_location_type`
`jail` | `prison` | `treatment_facility` | `state_hospital` | `psychiatric_facility` | `community` | `homeless` | `other`

### `court_jurisdiction` (Sprint 5 — dropdown)
Pre-populated list of Colorado Judicial Districts (1st through 22nd).

---

## Type Changes (Sprint 5 Migration)

| Column | Old Type | New Type | Migration Strategy |
|--------|----------|----------|-------------------|
| `suicide_risk` | boolean | text | `true` → `'historical'`, `false` → `'no_history'`, `NULL` → `NULL` |
| `violence_risk` | boolean | text | Same as above |
| `elopement_risk` | boolean | text | Same as above |

---

## Constraints & Keys

| Table | Constraint | Type | Column |
|-------|-----------|------|--------|
| `referral_inquiries` | `referral_inquiries_pkey` | PRIMARY KEY | `id` |
| `referral_submissions` | `referral_submissions_pkey` | PRIMARY KEY | `id` |
| `referral_submissions` | `referral_submissions_reviewed_by_fkey` | FOREIGN KEY | `reviewed_by` → users |
| `referral_submissions` | `idx_referral_code` | UNIQUE INDEX | `referral_code` (WHERE NOT NULL) |
| `referral_submissions` | `idx_admin_ref_id` | UNIQUE INDEX | `admin_ref_id` (WHERE NOT NULL) — **Sprint 6** |

---

## Database Functions & Triggers

| Name | Type | Purpose |
|------|------|---------|
| `generate_referral_code()` | Function (PL/pgSQL) | Generates unique `MON-XXXX` code, checks for collisions |
| `auto_set_referral_code()` | Function (PL/pgSQL) | Trigger function — sets `referral_code` if NULL at INSERT |
| `trg_auto_referral_code` | Trigger (BEFORE INSERT) | Fires `auto_set_referral_code()` on `referral_submissions` |
| `generate_admin_ref_id()` | Function (PL/pgSQL) | **Sprint 6** — Generates sequential `REF-MC-NNN` admin reference ID |
| `auto_set_admin_ref_id()` | Function (PL/pgSQL) | **Sprint 6** — Trigger function — sets `admin_ref_id` if NULL at INSERT |
| `trg_auto_admin_ref_id` | Trigger (BEFORE INSERT) | **Sprint 6** — Fires `auto_set_admin_ref_id()` on `referral_submissions` |
| `admin_ref_id_seq` | Sequence | **Sprint 6** — Sequential counter for admin reference IDs |
| `auto_archive_old_referrals()` | Function (PL/pgSQL) | Sprint 4 — archives records older than 30 days |

---

## Row Level Security (RLS)

RLS is **enabled** on both tables.

### `referral_inquiries`
| Policy | Role | Operation | Notes |
|--------|------|-----------|-------|
| `public_insert_inquiries` | `public` (anon) | INSERT | Anyone can submit a public inquiry |
| `authenticated_select_inquiries` | `authenticated` | SELECT | Logged-in users can read all inquiries |
| `authenticated_update_inquiries` | `authenticated` | UPDATE | Logged-in users can update inquiries |

### `referral_submissions`
| Policy | Role | Operation | Notes |
|--------|------|-----------|-------|
| `authenticated_insert_submissions` | `authenticated` | INSERT | Logged-in users can submit referrals |
| `authenticated_select_policy` | `authenticated` | SELECT | Logged-in users can read all submissions |
| `authenticated_update_policy` | `authenticated` | UPDATE | Logged-in users can update submissions |

### RLS Gaps / Concerns
- **No DELETE policies** — good, prevents accidental/malicious deletion
- **No role-based filtering** — any authenticated user sees ALL records (no admin vs. viewer distinction)
- **No anon INSERT on `referral_submissions`** — correct, secure form requires auth
- **Public INSERT on `referral_inquiries`** — correct, public form needs anon access
- **Future**: Should add role-based policies using `tenant_roles` / `role_permissions` tables

---

## Other Tables (Not Yet Audited)

These tables exist and likely support the RBAC system:

| Table | Columns | Likely Purpose |
|-------|---------|---------------|
| `users` | 9 | User accounts (linked to Supabase Auth) |
| `tenant_roles` | 8 | Role assignments per tenant/organization |
| `role_permissions` | 8 | Permission definitions per role |
| `corporate_clients` | 4 | Corporate/org client records |
| `programs` | 5 | Monarch program definitions |

> **TODO**: Audit these tables when implementing role-based access control

---

## Data Volume

| Table | Rows | Date Range |
|-------|------|-----------|
| `referral_inquiries` | 3 | Jan 31 – Feb 1, 2026 |
| `referral_submissions` | 35 | Jan 30 – Feb 3, 2026 |

---

## Migration Files

| File | Purpose | Status |
|------|---------|--------|
| `Code/Database/auto-archive.sql` | Sprint 4 — `archived_at` column + auto-archive function | Applied |
| `Code/Database/revised-form-migration.sql` | Sprint 5 — ~45 new columns, 3 type changes, referral code system | **Run before deploying updated forms** |
| `Code/Database/admin-ref-id-migration.sql` | Sprint 6 — admin_ref_id column, sequence, trigger, backfill | **Run before deploying Sprint 6 dashboard** |

---

## Key Schema Observations

1. **`referral_inquiries` has NO `priority` column** — the current dashboard filters on `priority` which doesn't exist. Use `is_priority_referral` (boolean) from `referral_submissions` or derive priority from inquiry context.

2. **`referral_inquiries` has NO `referral_source_type` column** — the TypeBadge in the dashboard references this field which only exists on `referral_submissions`.

3. **`referral_inquiries` uses `client_last_initial`** not `client_last_name` — privacy-preserving design for public form.

4. **The two tables have very different shapes** — 17 columns vs ~105 columns. The dashboard handles both with a unified view model.

5. **`referral_submissions.reviewed_by`** is a FK to users — the dashboard should eventually show who reviewed each referral.

6. **`current_medications` is jsonb** — not plain text. Export logic serializes this properly.

7. **`referral_submissions` has audit metadata** (ip_address, user_agent, session_id, time_spent_seconds) that's useful for admin view but should not be exported to EMR.

8. **Risk fields are text enums** (Sprint 5) — dashboard `RiskIndicator` component handles both boolean (for `medical_needs`) and text enum values (for `suicide_risk`, `violence_risk`, `elopement_risk`).

9. **`is_priority_referral` is admin-only** — not set by the referral form. `urgent_placement` is the form-side REQUEST checkbox. Admin determines actual priority on the dashboard.

10. **`referral_code` is auto-generated** — PL/pgSQL trigger creates it at INSERT time. Used for post-submission document uploads. Format: `MON-` + 4 alphanumeric chars.

11. **`admin_ref_id` is auto-generated** — PL/pgSQL trigger creates sequential IDs at INSERT time. Admin-facing only, shown in dashboard modal and exports. Format: `REF-MC-` + zero-padded sequential number. Not shared with referral sources.
